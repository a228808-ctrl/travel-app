<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠåˆ†å¸³ - Firebase é›²ç«¯åŒæ­¥ç‰ˆ</title>
    
    <!-- å¼•å…¥ Firebase SDK (ä½¿ç”¨ v10 Compatibility Mode æ–¹ä¾¿å–®é é–‹ç™¼) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #4f46e5; --secondary: #ec4899; --bg: #f1f5f9; --card: #ffffff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .container { max-width: 550px; width: 100%; }
        .card { background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .hidden { display: none; }
        h1, h2 { text-align: center; color: var(--primary); margin-top: 0; }
        
        input, select, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { opacity: 0.9; }
        .btn-calc { background: var(--secondary); margin-top: 20px; }
        
        .rate-bar { background: #e2e8f0; padding: 10px; border-radius: 8px; font-size: 12px; text-align: center; margin-bottom: 15px; color: #475569; }
        .entry-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
        .remark-tag { background: #f1f5f9; color: #64748b; font-size: 12px; padding: 2px 8px; border-radius: 4px; }
        .twd-text { font-weight: bold; color: var(--primary); }
        .share-link { background: #fffbeb; border: 1px solid #fde68a; padding: 10px; border-radius: 8px; font-size: 12px; word-break: break-all; margin-bottom: 15px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <!-- é é¢ 1: åˆå§‹è¨­å®š -->
    <div id="setupPage" class="card">
        <h1>ğŸŒ å»ºç«‹æ–°æ—…éŠ</h1>
        <input type="text" id="tripNameInput" placeholder="æ—…éŠåç¨± (å¦‚: 2024 æ±äº¬ä¹‹æ—…)">
        <input type="text" id="membersInput" placeholder="æˆå“¡å§“å (è«‹ç”¨é€—è™Ÿéš”é–‹, å¦‚: A,B,C)">
        <button onclick="createNewTrip()">å»ºç«‹æ—…éŠä¸¦åŒæ­¥é›²ç«¯</button>
    </div>

    <!-- é é¢ 2: ä¸»ä»‹é¢ -->
    <div id="mainPage" class="hidden">
        <h2 id="displayTripName">è¼‰å…¥ä¸­...</h2>
        <div class="share-link">
            ğŸ”— å‚³é€æ­¤é€£çµçµ¦æœ‹å‹å³å¯åŒæ­¥ä½¿ç”¨ï¼š<br>
            <strong id="currentLink"></strong>
        </div>
        
        <div id="rateDisplay" class="rate-bar">æ›´æ–°åŒ¯ç‡ä¸­...</div>

        <div class="card">
            <label>ä»˜æ¬¾äºº</label>
            <select id="personSelect"></select>
            <input type="text" id="remarkInput" placeholder="æ¶ˆè²»é …ç›® (å¦‚: å±…é…’å±‹)">
            <div style="display:flex; gap:8px;">
                <input type="number" id="amountInput" placeholder="é‡‘é¡" style="flex:2">
                <select id="currencyInput" style="flex:1">
                    <option value="TWD">TWD</option>
                    <option value="JPY">JPY</option>
                    <option value="EUR">EUR</option>
                </select>
            </div>
            <button onclick="addEntry()">ï¼‹ æ–°å¢æ¶ˆè²»</button>
        </div>

        <div class="card">
            <h3>ğŸ“Š æ¶ˆè²»ç´€éŒ„ (åŒæ­¥ä¸­)</h3>
            <div id="entryList" style="text-align:center; color:#94a3b8;">å°šæœªæœ‰è³‡æ–™</div>
            <button class="btn-calc" onclick="calculate()">ğŸ’° çµç®—åˆ†å¸³çµæœ</button>
        </div>

        <div id="resultCard" class="card hidden">
            <h3>ğŸ çµç®—å»ºè­°</h3>
            <div id="summaryArea" style="text-align:center; margin-bottom:15px; padding-bottom:15px; border-bottom:1px dashed #eee;"></div>
            <div id="resultList"></div>
            <button onclick="location.href=location.pathname" style="background:#64748b; margin-top:10px;">å»ºç«‹æ–°è¡Œç¨‹</button>
        </div>
    </div>
</div>

<script>
    // --- 1. Firebase é…ç½® (è«‹æ›¿æ›æˆä½ çš„é…ç½®) ---
    const firebaseConfig = {
        apiKey: "AIzaSyDeiGsT67EBlGCHAFmznJHGT28gsc_WU1g",
        authDomain: "grandpasplit.firebaseapp.com",
        databaseURL: "ttps://grandpasplit-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "grandpasplitD",
        storageBucket: "grandpasplit.firebasestorage.app",
        messagingSenderId: "388673972284",
        appId: "1:388673972284:web:dad6dbe7f93a46b6d8bb39"
    };

    // åˆå§‹åŒ– Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- 2. å…¨åŸŸè®Šæ•¸ ---
    let tripId = new URLSearchParams(window.location.search).get('tripId');
    let members = [];
    let exchangeRates = { JPY: 0.21, EUR: 34.5, TWD: 1 };

    // --- 3. åˆå§‹é‚è¼¯ ---
    if (tripId) {
        startRealtimeSync();
    }

    // å»ºç«‹æ–°è¡Œç¨‹
    function createNewTrip() {
        const name = document.getElementById('tripNameInput').value.trim();
        const membersStr = document.getElementById('membersInput').value.trim();
        if (!name || !membersStr) return alert("è«‹å¡«å¯«åç¨±èˆ‡æˆå“¡");

        const memberList = membersStr.split(',').map(s => s.trim()).filter(s => s);
        const newTripRef = db.ref('trips').push(); // ç”¢ç”Ÿå”¯ä¸€ ID
        
        newTripRef.set({
            name: name,
            members: memberList,
            createdAt: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            window.location.search = `?tripId=${newTripRef.key}`;
        });
    }

    // å³æ™‚åŒæ­¥ç›£è½
    function startRealtimeSync() {
        document.getElementById('setupPage').classList.add('hidden');
        document.getElementById('mainPage').classList.remove('hidden');
        document.getElementById('currentLink').innerText = window.location.href;

        // å–å¾—è¡Œç¨‹è³‡è¨Š
        db.ref(`trips/${tripId}`).on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return alert("æ‰¾ä¸åˆ°æ­¤è¡Œç¨‹");
            
            document.getElementById('displayTripName').innerText = "ğŸ“ " + data.name;
            members = data.members;
            
            // æ›´æ–°ä¸‹æ‹‰é¸å–®
            const select = document.getElementById('personSelect');
            select.innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join('');
            
            // æ¸²æŸ“æ¶ˆè²»åˆ—è¡¨
            renderEntries(data.entries);
        });

        fetchRates();
    }

    // æ–°å¢ä¸€ç­†æ¶ˆè²»
    function addEntry() {
        const name = document.getElementById('personSelect').value;
        const remark = document.getElementById('remarkInput').value.trim() || "æœªå‘½åæ”¯å‡º";
        const amount = parseFloat(document.getElementById('amountInput').value);
        const currency = document.getElementById('currencyInput').value;

        if (!amount || amount <= 0) return alert("è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡");

        const twd_amount = amount * exchangeRates[currency];

        db.ref(`trips/${tripId}/entries`).push({
            name, remark, amount, currency, twd_amount,
            createdAt: firebase.database.ServerValue.TIMESTAMP
        });

        document.getElementById('amountInput').value = "";
        document.getElementById('remarkInput').value = "";
    }

    // æ¸²æŸ“æ¸…å–®
    function renderEntries(entriesObj) {
        const container = document.getElementById('entryList');
        if (!entriesObj) {
            container.innerHTML = "å°šæœªæœ‰ä»»ä½•ç´€éŒ„";
            return;
        }

        const entries = Object.values(entriesObj);
        container.innerHTML = entries.map(e => `
            <div class="entry-item">
                <div>
                    <strong>${e.name}</strong> <span class="remark-tag">${e.remark}</span><br>
                    <small style="color:#94a3b8">${e.amount.toLocaleString()} ${e.currency}</small>
                </div>
                <div class="twd-text">$${Math.round(e.twd_amount).toLocaleString()} TWD</div>
            </div>
        `).reverse().join('');
    }

    // çµç®—é‚è¼¯
    async function calculate() {
        const snapshot = await db.ref(`trips/${tripId}/entries`).once('value');
        const entriesObj = snapshot.val();
        if (!entriesObj) return alert("é‚„æ²’æœ‰ä»»ä½•æ¶ˆè²»ç´€éŒ„ï¼");

        const entries = Object.values(entriesObj);
        let personTotals = {};
        members.forEach(m => personTotals[m] = 0);
        entries.forEach(e => personTotals[e.name] += e.twd_amount);

        const totalTWD = Object.values(personTotals).reduce((a, b) => a + b, 0);
        const avgTWD = totalTWD / members.length;

        let balances = members.map(m => ({ name: m, balance: personTotals[m] - avgTWD }));
        let creditors = balances.filter(b => b.balance > 0).sort((a, b) => b.balance - a.balance);
        let debtors = balances.filter(b => b.balance < 0).sort((a, b) => a.balance - b.balance);

        document.getElementById('summaryArea').innerHTML = `
            ç¸½æ”¯å‡º: $${Math.round(totalTWD).toLocaleString()} | æ¯äººå¹³åˆ†: <b>$${Math.round(avgTWD).toLocaleString()}</b>
        `;

        const resultList = document.getElementById('resultList');
        resultList.innerHTML = '';

        let i = 0, j = 0;
        while (i < debtors.length && j < creditors.length) {
            let pay = Math.min(Math.abs(debtors[i].balance), creditors[j].balance);
            if (pay > 0.5) {
                const div = document.createElement('div');
                div.style.padding = "10px";
                div.style.borderBottom = "1px solid #f1f5f9";
                div.innerHTML = `ğŸ’¸ <b>${debtors[i].name}</b> æ‡‰æ”¯ä»˜çµ¦ <b>${creditors[j].name}</b> <span style="color:var(--secondary)">$${Math.round(pay).toLocaleString()}</span> TWD`;
                resultList.appendChild(div);
            }
            debtors[i].balance += pay;
            creditors[j].balance -= pay;
            if (Math.abs(debtors[i].balance) < 1) i++;
            if (Math.abs(creditors[j].balance) < 1) j++;
        }

        document.getElementById('resultCard').classList.remove('hidden');
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    async function fetchRates() {
        try {
            const res = await fetch('https://open.er-api.com/v6/latest/TWD');
            const data = await res.json();
            exchangeRates.JPY = 1 / data.rates.JPY;
            exchangeRates.EUR = 1 / data.rates.EUR;
            document.getElementById('rateDisplay').innerText = `å³æ™‚åŒ¯ç‡: 1 JPY â‰ˆ ${exchangeRates.JPY.toFixed(4)} TWD | 1 EUR â‰ˆ ${exchangeRates.EUR.toFixed(2)} TWD`;
        } catch (e) {
            document.getElementById('rateDisplay').innerText = "ä½¿ç”¨é è¨­é›¢ç·šåŒ¯ç‡";
        }
    }
</script>

</body>
</html>